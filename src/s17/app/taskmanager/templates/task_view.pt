<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="s17.app.taskmanager">
<body>

<head>
    <metal:block fill-slot="top_slot"
                 tal:define="dummy python:request.set('disable_border',1)" />
    <metal:css fill-slot="style_slot">
        <link type="text/css"
              rel="stylesheet"
              href="++resource++s17.app.taskmanager/taskmanager.css" />
    </metal:css>
</head>

<metal:main fill-slot="content-core">
    <tal:main-macro metal:define-macro="content-core"
        tal:define="member context/@@plone_portal_state/member;
                    isAnon context/@@plone_portal_state/anonymous;
                    isSubmitter python:member.getId() == here.Creator();">

        <table class="vertical listing task-info-box" summary="Task details"
               i18n:attributes="summary"
               tal:define="toLocalizedTime nocall:context/@@plone/toLocalizedTime;
                           pas_member context/@@pas_member;
                           wtool context/portal_workflow;">
            <tbody>
            <tr tal:define="state python:wtool.getInfoFor(here, 'review_state');
                            state_title python:wtool.getTitleForStateOnType(state,
                            here.getPortalTypeName());">
                <th i18n:translate="">State</th>
                <td tal:content="state_title"
                    i18n:translate=""
                    tal:attributes="class string:task-${state}"/>
            </tr>

            <tr>
                <th width="30%" i18n:translate="">Priority</th>
                <td width="50%" tal:content="context/priority"></td>
            </tr>
            <tr>
                <th i18n:translate="">Submitted by</th>
                <td tal:define="creator python:pas_member.info(here.Creator())"
                    tal:content="creator/name_or_id" />

            </tr>
            <tr>
                <th i18n:translate="">Submitted on</th>
                <td tal:content="python:here.toLocalizedTime(here.created())" />
            </tr>
            <tr tal:condition="context/responsible">
                <th i18n:translate="">Responsible</th>
                <td tal:content="view/responsible"></td>
            </tr>
            <tr tal:condition="context/initial_date">
                <th i18n:translate="">Initial date</th>
                <td tal:content="python: context.initial_date.strftime('%d/%m/%Y')">
                </td>
            </tr>
            <tr tal:condition="context/end_date">
                <th i18n:translate="">End date</th>
                <td tal:content="python: context.end_date.strftime('%d/%m/%Y')"></td>
            </tr>
            <tr tal:condition="context/provided_date">
                <th i18n:translate="">Provided date</th>
                <td tal:content="python: context.provided_date.strftime('%d/%m/%Y')"></td>
            </tr>
            </tbody>
        </table>

        <form style="display: inline" action="@@watching"
              id="watch-task-form"
              tal:condition="python:not isAnon and not isSubmitter">
            <div class="formControls">
                <input tal:condition="view/is_watching"
                       class="standalone"
                       type="submit"
                       i18n:attributes="value"
                       value="Stop watching this task"
                        />
                <input tal:condition="not:view/is_watching"
                       class="context"
                       type="submit"
                       i18n:attributes="value"
                       value="Watch this task"
                        />
            </div>
        </form>

        <div tal:content="structure view/w/text/render" />

        <div class="visualClear"><!----></div>
        <tal:block condition="view/images">
            <fieldset>
                <legend i18n:translate="task_images">Images</legend>
                <tal:images tal:repeat="image view/images">
                    <div class="photoAlbumEntry">
                        <a tal:attributes="href string:${image/absolute_url}/view;
                                        title image/Description">
                    <span class="photoAlbumEntryWrapper">
                        <img src="" alt="" tal:replace="structure python:image.tag(scale='thumb', title=image.Description())" />
                    </span>
                    <span class="photoAlbumEntryTitle" tal:content="image/pretty_title_or_id">
                       Title
                    </span>
                        </a>
                    </div>
                </tal:images>
            </fieldset>
        </tal:block>
        <tal:block condition="view/files">
            <fieldset id="">
                <legend i18n:translate="task_files">Files</legend>
                <ul class="visualNoMarker">
                    <tal:related tal:repeat="item view/files">
                        <li tal:define="desc item/Description;
                                item_type item/portal_type;
                                portal context/@@plone_portal_state/portal;
                                putils portal/plone_utils;
                                item_type_class python:'contenttype-' + putils.normalizeString(item_type);
                                item_wf_state item/review_state | python:getInfoFor(item, 'review_state', '');
                                item_wf_state_class python:'state-' + putils.normalizeString(item_wf_state);
                                item_url item/getURL;">
                    <span tal:attributes="class item_type_class">
                        <a href="" class="visualIconPadding"
                           tal:attributes="href string:${item_url}/view;
                                           title desc;"
                           tal:content="item/pretty_title_or_id">
                        </a>
                    </span>
                        </li>
                    </tal:related>
                </ul>
            </fieldset>
        </tal:block>

        <div class="formControls">
            <form style="display: inline" action="edit"
                  tal:condition="python: user.has_permission('Modify portal content', here)">
                <input class="context"
                       type="submit"
                       i18n:attributes="value"
                       value="Edit task"
                       />
            </form>
            <a tal:condition="python: user.has_permission('Modify portal content', here)"
               title="" id="multiplefiles" class="contenttype-multiplefiles link-overlay" href="./@@media_uploader"
               style="cursor: pointer;">
                <span class="subMenuTitle">Upload multiple files or images</span></a>
        </div>

        <div class="visualClear"><!----></div>

        <tal:responses repeat="response_info view/responses">
            <div class="response-reply"
                 tal:define="id response_info/id;
                     response nocall:response_info/response;
                     html response_info/html;
                     toLocalizedTime nocall:context/@@plone/toLocalizedTime;">

                <div class="response-actions"
                     tal:condition="view/can_edit_response|view/can_delete_response">
                    <form method="post"
                          tal:attributes="action string:@@edit_response"
                          tal:condition="view/can_edit_response">
                        <input type="hidden" name="response_id" tal:attributes="value id" />
                        <input name="edit-response"
                               class="standalone"
                               type="submit"
                               i18n:attributes="value"
                               value="Edit"
                                />
                    </form>
                    <form method="post"
                          tal:attributes="action string:@@delete_response"
                          tal:condition="view/can_delete_response">
                        <input type="hidden" name="response_id" tal:attributes="value id" />
                        <input name="delete-response"
                               class="destructive"
                               type="submit"
                               i18n:attributes="value"
                               value="Delete"
                                />
                    </form>
                </div>

                <div class="response-info">
                    <span i18n:translate="task_added_by">Added by</span>
                <span class="contact-user"
                      tal:define="pas_member context/@@pas_member;
                                  creator python:pas_member.info(response.creator)"
                      tal:content="creator/name_or_id" />
                    <span i18n:translate="task_added_on">on</span>
                <span class="contact-user"
                      tal:content="python:toLocalizedTime(response.date, long_format=True)"/>
                    <div tal:repeat="delta response/changes"
                         tal:define="DateTime python:modules['DateTime'].DateTime">
                        <div tal:condition="python:delta['id'] != 'provided_date'">
                            <span i18n:translate="" tal:content="string:${delta/name}" />:
                            <span class="taskChange"
                                  i18n:translate=""
                                  i18n:domain="plone"
                                  tal:content="delta/before" />
                                &#8594;
                            <span class="taskChange"
                                  i18n:translate=""
                                  i18n:domain="plone"
                                  tal:content="delta/after" />
                        </div>
                        <div tal:condition="python:delta['id'] == 'provided_date'"
                             tal:define="before python:delta['before'];
                                         after python:delta['after'];">
                            <span i18n:translate="" tal:content="string:${delta/name}" />:
                            <span class="taskChange"
                                  i18n:translate=""
                                  i18n:domain="plone"
                                  tal:content=" python:toLocalizedTime(DateTime(before.isoformat()))" />
                            &#8594;
                            <span class="taskChange"
                                  i18n:translate=""
                                  i18n:domain="plone"
                                  tal:content="python: toLocalizedTime(DateTime(after.isoformat()))" />
                        </div>

                    </div>
                </div>
                <span tal:replace="structure html" />

            </div>
        </tal:responses>
        <tal:noadd condition="python:not user.has_permission('Modify portal content', here)">
            <p class="discreet"
               i18n:translate="msg_no_responses_can_be_added">
                No responses can be added.
            </p>
        </tal:noadd>

        <div class="formControls"
             tal:condition="context/@@plone_portal_state/anonymous">
            <div class="login-suggestion">
                <tal:block i18n:translate="login_suggestion_response">
                    If you can, please log in before submitting a reaction.
                </tal:block>
            </div>
            <form
                    tal:attributes="action string:${context/@@plone_portal_state/portal_url}/login_form?came_from=${here/absolute_url}">
                <input class="standalone"
                       type="submit"
                       value="Log in"
                       i18n:domain="plone"
                       i18n:attributes="value label_log_in;"
                        />
            </form>
        </div>

        <tal:add condition="python:user.has_permission('Modify portal content', here)">
            <h3 i18n:translate="title_add_response">Add response</h3>

            <form method="post" action="@@create_response"
                  enctype="multipart/form-data">

                <div class="field">
                    <label for="response"
                           i18n:translate="task_label_response">Response</label>

                    <div class="formHelp" id="response_help"
                         i18n:translate="task_help_response">
                        Please enter your response below
                    </div>
                    <div>
                        <tal:block define="inputname string:response;
                                   inputvalue string:;
                                   portal context/@@plone_portal_state/portal;
                                   member context/@@plone_portal_state/member;
                                   site_properties context/portal_properties/site_properties;
                                   default_editor python:site_properties.getProperty('default_editor').lower();
                                   user_editor python:member.getProperty('wysiwyg_editor', 'plone_wysiwyg').lower();
                                   editor python:user_editor or default_editor;
                                   portal_url context/@@plone_portal_state/portal_url;
                                   here_url context/@@plone_context_state/object_url;
                                   support python: path('nocall:here/%s_wysiwyg_support|here/%s/wysiwyg_support|here/portal_skins/plone_wysiwyg/wysiwyg_support' % (editor, editor));"
                                   on-error="string:$editor not installed correctly: ${error/value}">

                            <metal:block use-macro="support/macros/wysiwygEditorBox" />
                        </tal:block>
                    </div>

                </div>

                <div style="float: left; width: 49%;"
                     tal:condition="view/transitions_for_display">
                    <label for="transition"
                           i18n:translate="task_label_issueTransition">
                        Change task state
                    </label>

                    <div class="formHelp"
                         id="issueTransition_help"
                         i18n:translate="task_help_issueTransition">
                        Select a change of state in the task this response is for, if applicable
                    </div>

                    <tal:transitions
                            repeat="transition view/transitions_for_display">
                        <input class="noborder" name="transition"
                               value="" id="transition_1" type="radio"
                               tal:attributes="value transition/value;
                                 id python:transition['value'] or 'issuetransition-novalue';
                                 checked transition/checked;" />

                        <label
                                i18n:domain="plone"
                                i18n:translate=""
                                tal:attributes="for python:transition['value'] or 'issuetransition-novalue'"
                                tal:content="transition/label" />

                        <br />
                    </tal:transitions>
                </div>


                <div style="float: right; width: 49%;">
                    <label for="priority"
                           i18n:translate="task_label_newPriority">
                        Change task priority
                    </label>

                    <div class="formHelp" id="priority_help"
                         i18n:translate="task_help_newPriority">
                        Select the priority for this task
                    </div>

                    <tal:options
                            repeat="option view/priority_for_display">
                        <input class="noborder" name="priority"
                               value="" id="" type="radio"
                               tal:attributes="value option/value;
                                 id option/value;
                                 checked option/checked;" />

                        <label
                                tal:attributes="for option/value"
                                tal:content="option/label" />

                        <br />
                    </tal:options>
                </div>

                <div class="visualClear"><!----></div>

                <div style="float: left; width: 49%;"
                     tal:condition="view/responsibles_for_display">
                    <label for="responsible"
                           i18n:translate="task_label_newResponsible">
                        Change responsible
                    </label>

                    <div class="formHelp" id="responsible_help"
                         i18n:translate="task_help_newResponsible">
                        Select the responsible for this task
                    </div>

                    <tal:options
                            repeat="option view/responsibles_for_display">
                        <input class="noborder" name="responsible"
                               value="" id="" type="radio"
                               tal:attributes="value option/value;
                                 id option/value;
                                 checked option/checked;" />

                        <label
                                i18n:translate=""
                                tal:attributes="for option/value"
                                tal:content="option/label" />

                        <br />
                    </tal:options>
                </div>

                <div style="float: right; width: 49%;"
                     id="expected_date"
                     class="z3cformInlineValidation kssattr-fieldname-form.widgets.expected_date">

                    <label class="horizontal" for="expected_date"
                           i18n:translate="">
                        Expected date
                    </label>
                    <input type="text"
                           value=""
                           maxlength="2"
                           size="2"
                           class="date-widget date-field"
                           name="date-day"
                           id="date-day"> /
                    <select class="date-widget date-field" name="date-month" id="date-month">
                        <option value="" selected=""
                                tal:repeat="item view/months"
                                tal:attributes="value item/value;
                            selected python:item['selected'] and 'selected' or None"
                                tal:content="item/name">label</option>
                    </select> /
                    <input type="text"
                           value=""
                           maxlength="4"
                           size="4"
                           accesskey=""
                           alt=""
                           class="date-widget date-field"
                           name="date-year"
                           id="date-year">
                    <input type="hidden"
                           value="1"
                           name="date-empty-marker"
                           originalvalue="1">
                    <input type="hidden"
                           id="date-calendar"
                           name="date-calendar"
                           class="date"
                           originalvalue="">
                    <script type="text/javascript">
                        if (jQuery().dateinput) {
                            jQuery.tools.dateinput.localize("pt-br", {months: "janeiro,fevereiro,marco,abril,maio,junho,julho,agosto,setembro,outubro,novembro,dezembro",shortMonths: "jan,fev,mar,abr,mai,jun,jul,ago,set,out,nov,dez",days: "segunda-feira,terca-feira,quarta-feira,quinta-feira,sexta-feira,sabado,domingo",shortDays: "seg,ter,qua,qui,sex,sab,dom"});
                            jQuery("#date-calendar").dateinput({lang: "pt-br", change: function() { var value = this.getValue("yyyy-m-dd").split("-");
                                jQuery("#date-year").val(value[0]);
                                jQuery("#date-month").val(value[1]);
                                jQuery("#date-day").val(value[2]);
                            }, selectors: true, trigger: true, yearRange: [-10, 10]}).unbind('change')
                                    .bind('onShow', function (event) {
                                        var trigger_offset = jQuery(this).next().offset();
                                        jQuery(this).data('dateinput').getCalendar().offset(
                                                {top: trigger_offset.top+20, left: trigger_offset.left}
                                        );
                                    });
                            jQuery("#date-calendar").next().css("background","url(popup_calendar.gif)").css("height", "16px").css("width", "16px").css("display", "inline-block").css("vertical-align", "middle");
                        }
                    </script>
                </div>

                <div class="visualClear"><!----></div>

                <div class="formControls">
                    <input name='submit-response' class="standalone" value="Submit" type="submit"
                           i18n:domain="plone" i18n:attributes="value"/>
                </div>
            </form>
        </tal:add>

        <div class="visualClear"><!----></div>

    </tal:main-macro>
</metal:main>

</body>
</html>
