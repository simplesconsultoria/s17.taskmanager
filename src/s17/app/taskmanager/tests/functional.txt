This functional test simulates que funcionality of the task manager package.

Initial setup
=============
In this part of the test we authenticate in the site to create the initial
structure.

    >>> app = layer['app']
    >>> portal = layer['portal']
    >>> request = layer['request']

    >>> from cStringIO import StringIO
    >>> from plone.testing.z2 import Browser
    >>> browser = Browser(app)
    >>> browser.handleErrors = False  # see original exceptions
    >>> portal_url = portal.absolute_url()

    >>> from plone.app.testing import SITE_OWNER_NAME, SITE_OWNER_PASSWORD
    >>> browser.open(portal_url + '/login_form')
    >>> browser.getControl(name='__ac_name').value = SITE_OWNER_NAME
    >>> browser.getControl(name='__ac_password').value = SITE_OWNER_PASSWORD
    >>> browser.getControl(name='submit').click()

    >>> 'Você agora está autenticado' in browser.contents
    True

Adding new user
---------------
admin now adds a new user:

    >>> browser.open(portal_url + '/@@new-user')
    >>> browser.getControl('Nome completo').value = 'Some new user'
    >>> browser.getControl('Usuário').value = 'someuser'
    >>> browser.getControl('E-Mail').value = 'someuser@domain.com'
    >>> browser.getControl('Senha').value = 'secret'
    >>> browser.getControl('Confirme a senha').value = 'secret'
    >>> browser.getControl('Registrar').click()
    >>> 'Usuário adicionado' in browser.contents
    True


Adding a Panel tasks
--------------------
As admin, we create a Panel Tasks to include the tasks in there:

    >>> browser.open(portal_url)
    >>> browser.getLink('Painel de tarefas').click()
    >>> browser.getControl('Título').value = 'Painel de Tarefas'
    >>> browser.getControl('Descrição').value = 'Um painel de tarefas'
    >>> ctrl = browser.getControl(name='form.widgets.responsible:list')
    >>> ctrl.options
    ['--NOVALUE--', 'someuser', 'test_user_1_']
    >>> ctrl.value = ['someuser']
    >>> browser.getControl('Salvar').click()
    >>> 'Item criado' in browser.contents
    True


Adding a task
--------------
Now we add some tasks in the painel tasks.
    >>> browser.getLink(id='s17-app-taskmanager-task').click()
    >>> browser.getControl('Nome da tarefa').value = 'Uma tarefa'
    >>> ctrl = browser.getControl(name='form.widgets.responsible:list')
    >>> ctrl.options
    ['--NOVALUE--', 'someuser', 'test_user_1_']
    >>> ctrl.value = ['someuser']
    >>> ctrl = browser.getControl(name='form.widgets.priority:list')
    >>> ctrl.options
    ['Alta', 'Normal', 'Baixa']
    >>> ctrl.value = ['Normal']
    >>> browser.getControl(name='form.widgets.text').value = "<p>Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Proin eget dui. Phasellus tristique adipiscing justo. Vestibulum mattis, lorem vitae tristique molestie, turpis mi congue ligula, eget placerat libero mi quis massa. Proin pretium dictum nulla.</p>"
    >>> browser.getControl('Salvar').click()
    >>> 'Item criado' in browser.contents
    True

Edit task:

    >>> browser.getLink('Página Inicial').click()
    >>> browser.getLink('Painel de Tarefas').click()
    >>> browser.getLink('Uma tarefa').click()
    >>> browser.getControl('Editar tarefa').click()
    >>> ctrl = browser.getControl(name='form.widgets.priority:list')
    >>> ctrl.options
    ['Alta', 'Normal', 'Baixa']
    >>> ctrl.value = ['Baixa']
    >>> browser.getControl('Salvar').click()
    >>> 'Alterações salvas' in browser.contents
    True

Add response:

First, we'll add a new response without any information:

    >>> browser.getLink('Página Inicial').click()
    >>> browser.getLink('Painel de Tarefas').click()
    >>> browser.getLink('Uma tarefa').click()
    >>> browser.getControl(name='submit-response').click()
    >>> 'Erro' in browser.contents
    True

The real response:

    >>> browser.getLink('Página Inicial').click()
    >>> browser.getLink('Painel de Tarefas').click()
    >>> browser.getLink('Uma tarefa').click()
    >>> browser.getControl(name='response').value = "<p>Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Proin eget dui. Phasellus tristique adipiscing justo. Vestibulum mattis, lorem vitae tristique molestie, turpis mi congue ligula, eget placerat libero mi quis massa. Proin pretium dictum nulla.</p>"
    >>> ctrl = browser.getControl(name='transition')
    >>> ctrl.options
    ['', 'close', 'assign', 'reject']
    >>> ctrl.value = ['close']
    >>> ctrl = browser.getControl(name='priority')
    >>> ctrl.options
    ['Alta', 'Normal', 'Baixa']
    >>> ctrl.value = ['Alta']
    >>> browser.getControl(name='submit-response').click()
    >>> 'Adicionado por' in browser.contents
    True

Edit response:

First, we need to log in with another user

    >>> browser.open(portal_url + '/login_form')
    >>> browser.getControl(name='__ac_name').value = 'someuser'
    >>> browser.getControl(name='__ac_password').value = 'secret'
    >>> browser.getControl(name='submit').click()

    >>> 'Você agora está autenticado' in browser.contents
    True

Now we'll edit the response

    >>> browser.getLink('Página Inicial').click()
    >>> browser.getLink('Painel de Tarefas').click()
    >>> browser.getLink('Uma tarefa').click()
    >>> browser.getControl(name='edit-response').click()
    >>> 'Editar resposta' in browser.contents
    True
    >>> browser.getControl('Enviar').click()
    >>> 'Alterações salvas para a resposta com id 0' in browser.contents
    True

Delete reponse:

    >>> browser.getLink('Página Inicial').click()
    >>> browser.getLink('Painel de Tarefas').click()
    >>> browser.getLink('Uma tarefa').click()
    >>> browser.getControl(name='delete-response').click()
    >>> 'Resposta com o id 0 removida' in browser.contents
    True


